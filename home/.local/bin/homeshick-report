#!/usr/bin/env bash
set -eu

cd "${HOMESHICK_DIR:-$HOME/.homesick/repos}"

# Use colour output if either the output is a terminal or it has been
# explicitly requested with a `-c` option.
use_colour=
if [[ -t 1 ]]; then
	use_colour=YesPlease
fi
if (( $# > 0 )) && [[ "$1" = '-c' ]]; then
	use_colour=YesPlease
	shift
fi

if [[ "$use_colour" ]]; then
	# Output to terminal, so use colour.
	GREEN='\033[0;32m'
	BLUE='\033[0;34m'
	RED='\033[0;31m'
	PURPLE='\033[0;35m'
	RESET='\033[0m'
	up_to_date="${GREEN}up-to-date${RESET}"
	unavailable="${RED}could not check${RESET}"
	ahead="${RED}ahead${RESET}"
	behind="${PURPLE}behind${RESET}"
	modified="${RED}modified${RESET}"
	unknown="${BLUE}unexpected status %s${RESET}"
else
	up_to_date='up-to-date'
	unavailable='could not check'
	ahead='ahead'
	behind='behind'
	modified='modified'
	unknown='unexpected status: %s'
fi

if (( $# > 0 )); then
	repos=("$@")
else
	repos=(*)
fi

if [[ -x homeshick/bin/homeshick ]]; then
	rc=0
	for repo in "${repos[@]}"; do
		printf '%s: ' "$repo"
		status=0
		homeshick/bin/homeshick check -q "$repo" || status=$?
		case "$status" in
		0)
			printf "$up_to_date\\n"
			;;
		69)  # Unavailable
			printf "$unavailable\\n"
			(( 69 > rc && rc != 1 )) && rc=69
			;;
		85)  # Ahead
			printf "$ahead\\n"
			(( 85 > rc && rc != 1 )) && rc=85
			;;
		86)  # Behind
			printf "$behind\\n"
			(( 86 > rc && rc != 1 )) && rc=86
			;;
		88)  # Modified
			printf "$modified\\n"
			(( 88 > rc && rc != 1 )) && rc=88
			;;
		*)
			printf "$unknown\\n" "$status"
			rc=1
			;;
		esac
	done
	exit "$rc"
else
	printf 'Could not find homesick executable in %s\n' "$(pwd)" >&2
	exit 1
fi
