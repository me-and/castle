#!/usr/bin/env bash
set -euo pipefail

wrapmail () { ~/.local/bin/wrapmail "$@"; }

help () {
	printf -- '%s [<options>] <title> [<body>]\n' "$0"
	printf -- '\n'
	printf -- 'Options:\n'
	printf -- '  -d <duration>\n'
	printf -- '    e.g. `-d 30m`.\n'
	printf -- '  -D <duedate>\n'
	printf -- '    e.g. `-D "30 April"`.\n'
	printf -- '  -m <timemap>\n'
	printf -- '    e.g. `-m mornings` (-m = "map").\n'
	printf -- '  -p <priority>\n'
	printf -- '    e.g. `-p ASAP`.\n'
	printf -- '  -P <parent>\n'
	printf -- '    e.g. `-P "Household"`.\n'
	printf -- '  -t <tag>\n'
	printf -- '    e.g. `-t shopping`.\n'
	printf -- '  -w <plan>\n'
	printf -- '    e.g. `-t tomorrow` (-w = "when").\n'
	printf -- '  -z <zone>\n'
	printf -- '    e.g. `-z exercise`.\n'
}

SKEDPAL_BOARD_ADDRESS="$(< ~/.skedpal-board-address)"

properties=()
while getopts :hd:D:p:P:t:w:z: opt; do
	case "$opt" in
		h)	help
			exit 0
			;;
		d|w)	properties+=("$OPTARG");;
		D)	properties+=("due $OPTARG");;
		m)	properties+=("[@${OPTARG}]");;
		p|t|z)	properties+=("[/${OPTARG}]");;
		P)	properties+=("[#${OPTARG}]");;
		*)	printf -- '-%s is not a valid option!\n' "$OPTARG" >&2
			help >&2
			exit 64  # EX_USAGE
			;;
	esac
done
shift $(( OPTIND - 1 ))

case "$#" in
	0)	printf 'Missing task title\n' >&2
		help >&2
		exit 64  # EX_USAGE
		;;
	1)	subject="$1"
		have_body=
		;;
	2)	subject="$1"
		have_body=Yes
		body="$2"
		;;
	*)	printf 'Unexpected number of positional arguments: %d\n' "$#" >&2
		help >&2
		exit 64  # EX_USAGE
		;;
esac

if command -v vipe >/dev/null && [[ -t 0 ]]; then
	can_use_vipe=Yes
else
	can_use_vipe=
fi

if (( "${#properties[@]}" > 0 )); then
	if [[ "$have_body" ]] && [[ "$body" ]]; then
		printf -- '%s\n\n%s' "${properties[*]}" "$body"
	elif [[ "$have_body" ]]; then
		printf -- '%s\n' "${properties[*]}"
	elif [[ "$can_use_vipe" ]]; then
		printf -- '%s\n\n' "${properties[*]}"
		vipe
	else
		printf -- '%s\n\n' "${properties[*]}"
		cat
	fi
else
	if [[ "$have_body" ]] && [[ "$body" ]]; then
		printf -- '%s' "$body"
	elif [[ "$have_body" ]]; then
		:
	elif [[ "$can_use_vipe" ]]; then
		vipe
	else
		cat
	fi
fi | wrapmail -s "$subject" -- "$SKEDPAL_BOARD_ADDRESS"

# vim: ft=bash noet ts=8
